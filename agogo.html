<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agogo Tutor ‚Äî Offline Knowledge + General Help</title>

<style>
  :root {
    --bg: #f6f2ea;
    --text: #1f1f1f;
    --accent: #3b2412;
    --accent-strong: #d99a2b;
    --header: #3b2412;
    --card: #ffffffee;
    --shadow: rgba(0,0,0,0.12);
    --transition: all 0.3s ease;
    --bubble-user: #d99a2b;
    --bubble-user-text: #000;
    --bubble-bot: #ffffffee;
    --panel: #f9f5f0;
    --muted: #5a5a5a;
    --chat-bg: #e5ddd5;
    --input-bg: #ffffff;
  }

  body.dark {
    --bg: #0b0b0b;
    --text: #f5f5f5;
    --accent: #f0b24b;
    --accent-strong: #d99a2b;
    --header: #0b0b0b;
    --card: #161616dd;
    --shadow: rgba(0,0,0,0.6);
    --bubble-user: #d99a2b;
    --bubble-user-text: #000;
    --bubble-bot: #1a1a1a;
    --panel: #080808;
    --muted: #bfbfbf;
    --chat-bg: #0d1418;
    --input-bg: #1f2c34;
  }

  * {box-sizing: border-box; margin:0; padding:0;}

  html, body {
    height: 100%;
    font-family: 'Segoe UI', Helvetica Neue, Helvetica, Lucida Grande, Arial, Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 100%;
    margin: 0 auto;
    background: var(--chat-bg);
    position: relative;
  }

  /* Header */
  header {
    background: var(--header);
    color: #fff;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    z-index: 10;
    min-height: 60px;
  }

  .header-info {
    display: flex;
    flex-direction: column;
  }

  .header-title {
    font-weight: 600;
    color: var(--accent-strong);
    font-size: 16px;
    letter-spacing: 0.5px;
  }

  .header-subtitle {
    font-size: 13px;
    color: rgba(255,255,255,0.8);
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .header-btn {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: var(--transition);
  }

  .header-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  /* Main content area */
  .main-content {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  /* Chat area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  #chatbox {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
    background: var(--chat-bg);
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
  }

  /* Message bubbles */
  .message {
    max-width: 75%;
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 7.5px;
    word-wrap: break-word;
    position: relative;
    line-height: 1.4;
    white-space: pre-wrap;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  }

  .message.bot {
    align-self: flex-start;
    background: var(--bubble-bot);
    color: var(--text);
    border-top-left-radius: 0;
  }

  .message.user {
    align-self: flex-end;
    background: var(--bubble-user);
    color: var(--bubble-user-text);
    border-top-right-radius: 0;
  }

  .message-time {
    font-size: 11px;
    color: rgba(0,0,0,0.45);
    text-align: right;
    margin-top: 2px;
    float: right;
    margin-left: 8px;
  }

  .message.bot .message-time {
    color: rgba(0,0,0,0.45);
    text-align: left;
    float: none;
    margin-left: 0;
    display: block;
  }

  /* Input area */
  .input-area {
    display: flex;
    padding: 8px 16px;
    background: var(--input-bg);
    align-items: center;
    border-top: 1px solid rgba(0,0,0,0.08);
    min-height: 62px;
  }

  .input-container {
    flex: 1;
    display: flex;
    background: var(--input-bg);
    border-radius: 21px;
    padding: 9px 12px;
    margin: 5px 8px;
    border: 1px solid rgba(0,0,0,0.08);
  }

  #userInput {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--text);
    outline: none;
    font-size: 15px;
    padding: 0 8px;
  }

  .input-actions {
    display: flex;
    gap: 4px;
  }

  .input-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .input-btn:hover {
    background: rgba(0,0,0,0.05);
  }

  .send-btn {
    background: var(--accent-strong);
    border: none;
    color: #000;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 50%;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
  }

  .send-btn:hover {
    background: var(--accent);
  }

  /* Knowledge base panel */
  .kb-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: var(--panel);
    border-left: 1px solid rgba(0,0,0,0.08);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 20;
    overflow-y: auto;
    padding: 16px;
    box-shadow: -2px 0 12px rgba(0,0,0,0.1);
  }

  .kb-panel.open {
    transform: translateX(0);
  }

  .kb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .kb-title {
    font-weight: 600;
    color: var(--accent);
    font-size: 16px;
  }

  .close-kb {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
  }

  .kb-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--card);
    border: 1px solid rgba(0,0,0,0.05);
    cursor: pointer;
    transition: var(--transition);
  }

  .kb-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px var(--shadow);
  }

  .kb-item h4 {
    margin: 0 0 6px 0;
    color: var(--accent);
    font-size: 14px;
  }

  .kb-item p {
    margin: 0;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.4;
  }

  /* Footer */
  footer {
    text-align: center;
    font-size: 12px;
    color: var(--muted);
    padding: 8px 0;
    background: var(--header);
    color: rgba(255,255,255,0.7);
  }

  .footer-credit {
    font-weight: 600;
    color: var(--accent-strong);
  }

  /* Scrollbar */
  #chatbox::-webkit-scrollbar {
    width: 6px;
  }
  #chatbox::-webkit-scrollbar-thumb {
    background: var(--accent-strong);
    border-radius: 3px;
  }
  #chatbox::-webkit-scrollbar-track {
    background: transparent;
  }

  .kb-panel::-webkit-scrollbar {
    width: 4px;
  }
  .kb-panel::-webkit-scrollbar-thumb {
    background: var(--accent-strong);
    border-radius: 2px;
  }
  .kb-panel::-webkit-scrollbar-track {
    background: transparent;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .kb-panel {
      width: 85%;
    }
    
    .message {
      max-width: 85%;
    }
    
    .header-title {
      font-size: 15px;
    }
    
    .header-subtitle {
      font-size: 12px;
    }
  }

  @media (max-width: 480px) {
    .kb-panel {
      width: 100%;
    }
    
    .input-area {
      padding: 8px 12px;
    }
    
    .input-container {
      margin: 5px 4px;
    }
  }

  /* Welcome message */
  .welcome-message {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 14px;
    margin-top: 20px;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    background: var(--bubble-bot);
    border-radius: 7.5px;
    border-top-left-radius: 0;
    align-self: flex-start;
    max-width: 70px;
    margin: 4px 0;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
  }
</style>
</head>

<body>
  <div class="app-container">
    <header>
      <div class="header-info">
        <div class="header-title">üêù Agogo AI Tutor</div>
        <div class="header-subtitle">Business Studies ‚Ä¢ Offline Mode</div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="theme-toggle" aria-label="Toggle theme">üåô</button>
        <button class="header-btn" id="kb-toggle" aria-label="Knowledge base">üìö</button>
        <button class="header-btn" id="clear-btn" aria-label="Clear chat">üóëÔ∏è</button>
      </div>
    </header>

    <div class="main-content">
      <div class="chat-area">
        <div id="chatbox" role="log" aria-live="polite"></div>
      </div>

      <div class="kb-panel" id="kb-panel">
        <div class="kb-header">
          <div class="kb-title">Course Notes</div>
          <button class="close-kb" id="close-kb">‚úï</button>
        </div>
        <div id="kbList"></div>
        <div style="margin-top:16px;font-size:13px;color:var(--muted);padding:0 8px;">
          Click on any topic to automatically ask about it in the chat.
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-container">
        <button class="input-btn" aria-label="Attach file">üìé</button>
        <input id="userInput" placeholder="Type a message..." aria-label="Type your message"/>
        <div class="input-actions">
          <button class="input-btn" aria-label="Emoji">üòä</button>
        </div>
      </div>
      <button id="sendBtn" class="send-btn" aria-label="Send message">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
      </button>
    </div>

    <footer>
      <span class="footer-credit">Designed by James Mlelemba</span> ‚Ä¢ üêù Agogo AI Tutor
    </footer>
  </div>

<script>
/* -----------------------
   Knowledge base - Semester 1 Business Studies
   Each item: id, title, content, keywords (array)
   Edit or extend these entries as you like.
   ----------------------- */
const KB = [
  {
    id: "micro_intro",
    title: "Microeconomics ‚Äî Introduction",
    content:
`Microeconomics studies how individual consumers, households and firms make decisions under scarcity.
Key concepts: scarcity, opportunity cost, demand, supply, equilibrium, elasticity, marginal cost and benefit.`,
    keywords: ["microeconomics","scarcity","opportunity cost","demand","supply","equilibrium","elasticity","marginal"]
  },
  {
    id: "demand_supply",
    title: "Demand & Supply",
    content:
`Demand: quantity buyers want at different prices. Law of Demand: price up ‚Üí quantity demanded down (ceteris paribus).
Supply: quantity sellers offer. Law of Supply: price up ‚Üí quantity supplied up.
Market equilibrium: price where quantity demanded = quantity supplied. Changes in non-price factors shift curves.`,
    keywords: ["demand","supply","law of demand","law of supply","equilibrium","shift","price"]
  },
  {
    id: "elasticity",
    title: "Elasticity",
    content:
`Elasticity measures responsiveness. Price elasticity of demand = % change in quantity demanded / % change in price.
If |PED| > 1 demand is elastic; < 1 inelastic. Income elasticity, cross elasticity also important for businesses.`,
    keywords: ["elasticity","price elasticity","ped","income elasticity","cross elasticity"]
  },
  {
    id: "costs",
    title: "Costs (Fixed, Variable, Marginal)",
    content:
`Fixed costs do not change with output (rent, salaries). Variable costs change (materials).
Total cost = fixed + variable. Marginal cost = cost to produce one more unit. Firms use these for pricing and production decisions.`,
    keywords: ["fixed cost","variable cost","marginal cost","total cost","production"]
  },
  {
    id: "market_structures",
    title: "Market Structures",
    content:
`Perfect competition: many firms, identical products, price takers.
Monopoly: single seller, high barriers to entry.
Oligopoly: few large firms, strategic behaviour.
Monopolistic competition: many firms, differentiated products.`,
    keywords: ["perfect competition","monopoly","oligopoly","monopolistic","market structure"]
  },
  {
    id: "macro_intro",
    title: "Macroeconomics ‚Äî Introduction",
    content:
`Macroeconomics studies the whole economy: GDP, inflation, unemployment, fiscal and monetary policy, economic growth and balance of payments.`,
    keywords: ["macroeconomics","gdp","inflation","unemployment","fiscal policy","monetary policy"]
  },
  {
    id: "gdp_inflation",
    title: "GDP & Inflation",
    content:
`GDP = market value of final goods and services. Inflation = sustained increase in price level (CPI often used).
High inflation reduces purchasing power; deflation can harm growth.`,
    keywords: ["gdp","inflation","cpi","price level"]
  },
  {
    id: "business_law",
    title: "Business Law ‚Äî Contracts & Types",
    content:
`Contract essentials: offer, acceptance, consideration, capacity, and legality.
Contracts may be valid, void, or voidable. Company types: sole trader, partnership, private company, public company.`,
    keywords: ["contract","offer","acceptance","consideration","company","partnership","sole trader"]
  },
  {
    id: "management",
    title: "Business Management",
    content:
`Management functions: planning, organizing, staffing, directing, and controlling.
Levels: top, middle, lower. Forms of business ownership: sole trader, partnership, corporation, cooperative.`,
    keywords: ["management","planning","organizing","staffing","directing","controlling","business ownership"]
  },
  {
    id: "communication",
    title: "Communication Skills",
    content:
`Types: verbal, non-verbal, written, visual. Barriers: noise, language, culture, emotions. Key skills: clarity, active listening, feedback, confidence.`,
    keywords: ["communication","verbal","written","listening","feedback","barriers"]
  },
  {
    id: "ict",
    title: "ICT / Computer Applications",
    content:
`Basics of hardware and software, operating systems, MS Word/Excel/PowerPoint, internet basics, email, and file management. Data protection basics are essential.`,
    keywords: ["ict","computer","excel","word","powerpoint","internet","email","data protection"]
  },
  {
    id: "maths_business",
    title: "Mathematics for Business",
    content:
`Key topics: percentages, ratios, proportions, simple & compound interest, linear equations, demand/supply functions, and break-even analysis.`,
    keywords: ["percentages","ratios","interest","break-even","equations","maths"]
  },
  {
    id: "life_skills",
    title: "Life & Managerial Skills",
    content:
`Life skills: cognitive, interpersonal and emotional skills. Important: time management, decision making, stress control, conflict resolution, and leadership.`,
    keywords: ["life skills","time management","decision making","stress","conflict resolution"]
  },
  {
    id: "exam_tips",
    title: "Exam Tips & Study Strategy",
    content:
`Understand core concepts first. Make short notes, practice past papers, use diagrams and examples (use Malawi examples where possible). Manage time during exams and revise regularly.`,
    keywords: ["exam","revision","past papers","study","tips","exam tips"]
  }
];

/* -----------------------
   Theme toggle functionality
   ----------------------- */
const themeToggle = document.getElementById('theme-toggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Load saved theme
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  themeToggle.textContent = '‚òÄÔ∏è';
}

/* -----------------------
   Knowledge base panel toggle
   ----------------------- */
const kbToggle = document.getElementById('kb-toggle');
const kbPanel = document.getElementById('kb-panel');
const closeKb = document.getElementById('close-kb');

kbToggle.addEventListener('click', () => {
  kbPanel.classList.add('open');
});

closeKb.addEventListener('click', () => {
  kbPanel.classList.remove('open');
});

// Close panel when clicking outside
document.addEventListener('click', (e) => {
  if (!kbPanel.contains(e.target) && !kbToggle.contains(e.target) && kbPanel.classList.contains('open')) {
    kbPanel.classList.remove('open');
  }
});

/* -----------------------
   Utility: sanitize and tokenize
   ----------------------- */
function tokenize(text){
  return text.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
}

/* -----------------------
   Simple retrieval: count keyword hits
   - Looks at KB keywords and inside content
   - Returns best match and score
   ----------------------- */
function retrieveBestMatch(question){
  const qTokens = tokenize(question);
  let best = {score:0, item:null, matches:0};
  for(const item of KB){
    // keyword hit count
    const kws = item.keywords.map(k=>k.toLowerCase());
    let score = 0;
    for(const t of qTokens){
      if(kws.some(k=>k.includes(t) || t.includes(k))) score += 3;
      // check content tokens
      if(item.content.toLowerCase().includes(t)) score += 1;
    }
    // small boost for title matches
    const titleTokens = tokenize(item.title);
    for(const t of qTokens) if(titleTokens.includes(t)) score += 2;
    if(score > best.score){
      best = {score, item, matches: score};
    }
  }
  return best;
}

/* -----------------------
   Compose a natural reply:
   - If strong KB match: return KB content + short example
   - If weak match: return a general explanation (synthesized)
   - Also include "See topic" label for clarity
   ----------------------- */
function composeReply(question){
  const best = retrieveBestMatch(question);
  // threshold tuning: consider match strong if score >= 6 (empirical)
  if(best.item && best.score >= 6){
    // Return KB content, then a short Malawi-specific example or study tip
    const kbText = best.item.content;
    const example = generateExample(best.item.id, question);
    return `üìö ${best.item.title}\n\n${kbText}\n\n${example}`;
  } else {
    // fallback: try to provide a useful generic explanation
    return generalExplain(question);
  }
}

/* -----------------------
   Generate a short Malawi-related example for some topics
   ----------------------- */
function generateExample(kbId, question){
  switch(kbId){
    case "demand_supply":
      return "üá≤üáº Example: If the price of maize increases due to poor harvests, quantity demanded will fall and supply may increase if farmers can sell more at higher prices‚Äîuntil equilibrium adjusts.";
    case "micro_intro":
      return "üá≤üáº Example: A small shop in Lilongwe decides whether to stock imported rice or local maize‚Äîits choice depends on prices, customer demand, and storage costs (opportunity cost).";
    case "elasticity":
      return "üá≤üáº Example: Salt has inelastic demand (people buy similar amounts despite small price changes), while luxury goods are more elastic.";
    case "management":
      return "üìù Study tip: For planning questions, show clear steps: objective ‚Üí SWOT ‚Üí resources ‚Üí timeline ‚Üí control metrics.";
    case "exam_tips":
      return "üìù Tip: Summarise each topic in one page, practise past questions, and time yourself.";
    default:
      return "üí° Tip: Use simple examples, define terms, and show one short Malawi example for clarity.";
  }
}

/* -----------------------
   General explanation generator (fallback)
   - Tries simple templates: defines terms found, explains cause-effect
   ----------------------- */
function generalExplain(question){
  const q = question.toLowerCase();
  // quick pattern answers
  if(q.includes("what is") || q.includes("define") || q.startsWith("define")){
    // try to detect a keyword from KB
    for(const item of KB){
      for(const kw of item.keywords){
        if(q.includes(kw.split(" ")[0])){
          return `üìö ${item.title}:\n\n${item.content}\n\n(Provided as a general explanation based on course notes.)`;
        }
      }
    }
  }

  if(q.includes("how") && q.includes("change") || q.includes("how to")){
    return "üí° General advice: break problems into steps, apply core concepts (e.g., for management use planning‚Üíorganising‚Üíleading‚Üícontrolling), and give local examples.";
  }

  if(q.includes("example") || q.includes("give an example")){
    return "üá≤üáº Example: For supply and demand, imagine fuel price rises‚Äîdrivers reduce trips (demand falls), and fuel suppliers may increase supply if they can find higher-priced markets.";
  }

  // fallback short study answer
  return "üí° I don't have an exact note for that phrase, but here's a useful explanation: identify the key concept, define it simply, list 2‚Äì3 main points, and finish with a short real-life example related to Malawi.";
}

/* -----------------------
   Chat UI + logic
   ----------------------- */
const chatbox = document.getElementById('chatbox');
const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clear-btn');
const kbList = document.getElementById('kbList');

let history = JSON.parse(localStorage.getItem('luanar_chat_history')) || [];

/* Format time for messages */
function formatTime(date = new Date()) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

/* render KB list */
function renderKB(){
  kbList.innerHTML = '';
  for(const item of KB){
    const node = document.createElement('div');
    node.className = 'kb-item';
    node.innerHTML = `<h4>${item.title}</h4><p>${item.content.substring(0,100)}${item.content.length>100?"...":""}</p>`;
    node.addEventListener('click', ()=> {
      // on click, paste a suggested question into input
      input.value = `Explain ${item.title}`;
      input.focus();
      kbPanel.classList.remove('open');
    });
    kbList.appendChild(node);
  }
}

/* render history */
function renderHistory(){
  chatbox.innerHTML = '';
  for(const m of history){
    appendMessage(m.text, m.sender, m.time, false);
  }
  chatbox.scrollTop = chatbox.scrollHeight;
}

function appendMessage(text, sender, time = Date.now(), save = true){
  // Remove any existing typing indicator
  const typingIndicator = document.querySelector('.typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
  
  const div = document.createElement('div');
  div.className = 'message ' + (sender==='user' ? 'user' : 'bot');
  
  const timeFormatted = formatTime(new Date(time));
  div.innerHTML = `${text}<div class="message-time">${timeFormatted}</div>`;
  
  chatbox.appendChild(div);
  chatbox.scrollTop = chatbox.scrollHeight;
  
  if(save){
    history.push({text, sender, time});
    localStorage.setItem('luanar_chat_history', JSON.stringify(history));
  }
}

function showTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator';
  typingDiv.innerHTML = `
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  `;
  chatbox.appendChild(typingDiv);
  chatbox.scrollTop = chatbox.scrollHeight;
}

/* send flow */
async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  appendMessage(q, 'user');
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  // Compute answer (simulate small delay)
  setTimeout(() => {
    const reply = composeReply(q);
    appendMessage(reply, 'bot');
  }, 1000 + Math.random() * 1000);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', e => { 
  if(e.key === 'Enter') handleSend(); 
});

clearBtn.addEventListener('click', ()=> {
  if(confirm('Clear chat history? This will remove saved messages from this browser.')){
    history = [];
    localStorage.removeItem('luanar_chat_history');
    renderHistory();
    appendMessage("Welcome! I'm the üêù Agogo Offline Tutor. Ask about microeconomics, management, business law, ICT, maths, life skills, or tap the üìö icon to see course notes.", 'bot');
  }
});

/* keyboard shortcuts: type 'topics' to show KB titles */
input.addEventListener('input', e=>{
  if(e.target.value.trim().toLowerCase()==='topics'){
    e.target.value = '';
    // show a helpful bot list
    const titles = KB.map(i=>`‚Ä¢ ${i.title}`).join('\n');
    appendMessage('Available topics:\n' + titles, 'bot');
  }
});

/* initial render */
renderKB();
renderHistory();

/* If no history, show a welcome message */
if(history.length === 0){
  appendMessage("Welcome! I'm the  üêù Agogo Offline Tutor. Ask about microeconomics, management, business law, ICT, maths, life skills, or tap the üìö icon to see course notes.", 'bot');
}

/* Expose KB for quick editing in console (optional) */
window.LUANAR_KB = KB;
</script>
</body>
</html>