<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agogo Tutor ‚Äî Offline Knowledge + General Help</title>

<style>
  :root {
    --bg: #f6f2ea;
    --text: #1f1f1f;
    --accent: #3b2412;
    --accent-strong: #d99a2b;
    --header: #3b2412;
    --card: #ffffffee;
    --shadow: rgba(0,0,0,0.12);
    --transition: all 0.3s ease;
    --bubble-user: #d99a2b;
    --bubble-user-text: #000;
    --bubble-bot: #ffffffee;
    --panel: #f9f5f0;
    --muted: #5a5a5a;
    --chat-bg: #e5ddd5;
    --input-bg: #ffffff;
  }

  body.dark {
    --bg: #0b0b0b;
    --text: #f5f5f5;
    --accent: #f0b24b;
    --accent-strong: #d99a2b;
    --header: #0b0b0b;
    --card: #161616dd;
    --shadow: rgba(0,0,0,0.6);
    --bubble-user: #d99a2b;
    --bubble-user-text: #000;
    --bubble-bot: #1a1a1a;
    --panel: #080808;
    --muted: #bfbfbf;
    --chat-bg: #0d1418;
    --input-bg: #1f2c34;
  }

  * {box-sizing: border-box; margin:0; padding:0;}

  html, body {
    height: 100%;
    font-family: 'Segoe UI', Helvetica Neue, Helvetica, Lucida Grande, Arial, Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 100%;
    margin: 0 auto;
    background: var(--chat-bg);
    position: relative;
  }

  /* Header */
  header {
    background: var(--header);
    color: #fff;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    z-index: 10;
    min-height: 60px;
    flex-shrink: 0;
  }

  .header-info {
    display: flex;
    flex-direction: column;
  }

  .header-title {
    font-weight: 600;
    color: var(--accent-strong);
    font-size: 16px;
    letter-spacing: 0.5px;
  }

  .header-subtitle {
    font-size: 13px;
    color: rgba(255,255,255,0.8);
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .header-btn {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: var(--transition);
  }

  .header-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  /* Main content area */
  .main-content {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
    flex-direction: column;
  }

  /* Chat area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    min-height: 0;
  }

  #chatbox {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
    background: var(--chat-bg);
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
  }

  /* Message bubbles */
  .message {
    max-width: 75%;
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 7.5px;
    word-wrap: break-word;
    position: relative;
    line-height: 1.4;
    white-space: pre-wrap;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  }

  .message.bot {
    align-self: flex-start;
    background: var(--bubble-bot);
    color: var(--text);
    border-top-left-radius: 0;
  }

  .message.user {
    align-self: flex-end;
    background: var(--bubble-user);
    color: var(--bubble-user-text);
    border-top-right-radius: 0;
  }

  .message-time {
    font-size: 11px;
    color: rgba(0,0,0,0.45);
    text-align: right;
    margin-top: 2px;
    float: right;
    margin-left: 8px;
  }

  .message.bot .message-time {
    color: rgba(0,0,0,0.45);
    text-align: left;
    float: none;
    margin-left: 0;
    display: block;
  }

  /* Input area - FIXED POSITION */
  .input-area {
    display: flex;
    padding: 8px 16px;
    background: var(--input-bg);
    align-items: center;
    border-top: 1px solid rgba(0,0,0,0.08);
    min-height: 62px;
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    z-index: 5;
  }

  .input-container {
    flex: 1;
    display: flex;
    background: var(--input-bg);
    border-radius: 21px;
    padding: 9px 12px;
    margin: 5px 8px;
    border: 1px solid rgba(0,0,0,0.08);
  }

  #userInput {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--text);
    outline: none;
    font-size: 15px;
    padding: 0 8px;
  }

  .input-actions {
    display: flex;
    gap: 4px;
  }

  .input-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .input-btn:hover {
    background: rgba(0,0,0,0.05);
  }

  .send-btn {
    background: var(--accent-strong);
    border: none;
    color: #000;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 50%;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
  }

  .send-btn:hover {
    background: var(--accent);
  }

  /* Knowledge base panel */
  .kb-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: var(--panel);
    border-left: 1px solid rgba(0,0,0,0.08);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 20;
    overflow-y: auto;
    padding: 16px;
    box-shadow: -2px 0 12px rgba(0,0,0,0.1);
  }

  .kb-panel.open {
    transform: translateX(0);
  }

  .kb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .kb-title {
    font-weight: 600;
    color: var(--accent);
    font-size: 16px;
  }

  .close-kb {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
  }

  .kb-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--card);
    border: 1px solid rgba(0,0,0,0.05);
    cursor: pointer;
    transition: var(--transition);
  }

  .kb-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px var(--shadow);
  }

  .kb-item h4 {
    margin: 0 0 6px 0;
    color: var(--accent);
    font-size: 14px;
  }

  .kb-item p {
    margin: 0;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.4;
  }

  /* Footer */
  footer {
    text-align: center;
    font-size: 12px;
    color: var(--muted);
    padding: 8px 0;
    background: var(--header);
    color: rgba(255,255,255,0.7);
    flex-shrink: 0;
  }

  .footer-credit {
    font-weight: 600;
    color: var(--accent-strong);
  }

  /* Scrollbar */
  #chatbox::-webkit-scrollbar {
    width: 6px;
  }
  #chatbox::-webkit-scrollbar-thumb {
    background: var(--accent-strong);
    border-radius: 3px;
  }
  #chatbox::-webkit-scrollbar-track {
    background: transparent;
  }

  .kb-panel::-webkit-scrollbar {
    width: 4px;
  }
  .kb-panel::-webkit-scrollbar-thumb {
    background: var(--accent-strong);
    border-radius: 2px;
  }
  .kb-panel::-webkit-scrollbar-track {
    background: transparent;
  }

  /* Smart AI Features */
  .suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    background: var(--input-bg);
    border-top: 1px solid rgba(0,0,0,0.08);
    flex-shrink: 0;
    max-height: 80px;
    overflow-y: auto;
    position: sticky;
    bottom: 62px;
    z-index: 4;
  }

  .suggestion-chip {
    background: var(--card);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text);
    white-space: nowrap;
  }

  .suggestion-chip:hover {
    background: var(--accent-strong);
    color: #000;
  }

  .confidence-meter {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
    font-style: italic;
  }

  .follow-up-questions {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px dashed rgba(0,0,0,0.1);
  }

  .follow-up-title {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .follow-up-item {
    font-size: 12px;
    color: var(--accent);
    cursor: pointer;
    margin: 2px 0;
    padding: 2px 0;
  }

  .follow-up-item:hover {
    text-decoration: underline;
  }

  /* Welcome message */
  .welcome-message {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 14px;
    margin-top: 20px;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    background: var(--bubble-bot);
    border-radius: 7.5px;
    border-top-left-radius: 0;
    align-self: flex-start;
    max-width: 70px;
    margin: 4px 0;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .kb-panel {
      width: 85%;
    }
    
    .message {
      max-width: 85%;
    }
    
    .header-title {
      font-size: 15px;
    }
    
    .header-subtitle {
      font-size: 12px;
    }
    
    /* Mobile-specific adjustments */
    .main-content {
      height: calc(100vh - 60px - 62px - 60px);
    }
    
    .chat-area {
      height: 100%;
    }
    
    #chatbox {
      padding: 12px;
      padding-bottom: 70px; /* Extra padding to account for suggestions */
    }
    
    .suggestion-chips {
      max-height: 60px;
      padding: 8px 12px;
      gap: 6px;
      bottom: 62px;
    }
    
    .suggestion-chip {
      font-size: 12px;
      padding: 5px 10px;
    }
    
    .input-area {
      padding: 8px 12px;
      min-height: 56px;
      position: sticky;
      bottom: 0;
    }
    
    .input-container {
      margin: 5px 4px;
    }
    
    footer {
      font-size: 11px;
      padding: 6px 0;
    }
  }

  @media (max-width: 480px) {
    .kb-panel {
      width: 100%;
    }
    
    .message {
      max-width: 90%;
    }
    
    .suggestion-chips {
      max-height: 50px;
      padding: 6px 10px;
      bottom: 56px;
    }
    
    .suggestion-chip {
      font-size: 11px;
      padding: 4px 8px;
    }
    
    .input-area {
      padding: 6px 10px;
    }
    
    .header {
      padding: 8px 12px;
      min-height: 54px;
    }
    
    .header-title {
      font-size: 14px;
    }
    
    .header-subtitle {
      font-size: 11px;
    }
    
    #chatbox {
      padding-bottom: 60px;
    }
  }

  /* Extra small devices */
  @media (max-width: 360px) {
    .suggestion-chips {
      max-height: 45px;
      bottom: 56px;
    }
    
    .suggestion-chip {
      font-size: 10px;
      padding: 3px 6px;
    }
    
    #chatbox {
      padding: 10px;
      padding-bottom: 55px;
    }
    
    .message {
      max-width: 95%;
      padding: 6px 10px;
    }
  }
</style>
</head>

<body>
  <div class="app-container">
    <header>
      <div class="header-info">
        <div class="header-title">üêù Agogo AI Tutor</div>
        <div class="header-subtitle">Business Studies ‚Ä¢ Offline Mode ‚Ä¢ Smart AI</div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="theme-toggle" aria-label="Toggle theme">üåô</button>
        <button class="header-btn" id="kb-toggle" aria-label="Knowledge base">üìö</button>
        <button class="header-btn" id="clear-btn" aria-label="Clear chat">üóëÔ∏è</button>
      </div>
    </header>

    <div class="main-content">
      <div class="chat-area">
        <div id="chatbox" role="log" aria-live="polite"></div>
      </div>

      <div class="kb-panel" id="kb-panel">
        <div class="kb-header">
          <div class="kb-title">Course Notes</div>
          <button class="close-kb" id="close-kb">‚úï</button>
        </div>
        <div id="kbList"></div>
        <div style="margin-top:16px;font-size:13px;color:var(--muted);padding:0 8px;">
          Click on any topic to automatically ask about it in the chat.
        </div>
      </div>
    </div>

    <div class="suggestion-chips" id="suggestionChips">
      <!-- Dynamic suggestion chips will appear here -->
    </div>

    <div class="input-area">
      <div class="input-container">
        <button class="input-btn" aria-label="Attach file">üìé</button>
        <input id="userInput" placeholder="Type a message..." aria-label="Type your message"/>
        <div class="input-actions">
          <button class="input-btn" aria-label="Emoji">üòä</button>
        </div>
      </div>
      <button id="sendBtn" class="send-btn" aria-label="Send message">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
      </button>
    </div>

    <footer>
      <span class="footer-credit">Designed by James Mlelemba</span> ‚Ä¢ üêù Agogo AI Tutor ‚Ä¢ Smart AI Enhanced
    </footer>
  </div>

<script>
/* -----------------------
   Enhanced Knowledge Base - All Courses
   ----------------------- */
const KB = [
  {
    id: "micro_intro",
    title: "Microeconomics ‚Äî Introduction",
    content:
`Microeconomics studies how individual consumers, households and firms make decisions under scarcity.
Key concepts: scarcity, opportunity cost, demand, supply, equilibrium, elasticity, marginal cost and benefit.`,
    keywords: ["microeconomics","scarcity","opportunity cost","demand","supply","equilibrium","elasticity","marginal"],
    course: "Elementary Microeconomics"
  },
  {
    id: "demand_supply",
    title: "Demand & Supply",
    content:
`Demand: quantity buyers want at different prices. Law of Demand: price up ‚Üí quantity demanded down (ceteris paribus).
Supply: quantity sellers offer. Law of Supply: price up ‚Üí quantity supplied up.
Market equilibrium: price where quantity demanded = quantity supplied. Changes in non-price factors shift curves.`,
    keywords: ["demand","supply","law of demand","law of supply","equilibrium","shift","price"],
    course: "Elementary Microeconomics"
  },
  {
    id: "elasticity",
    title: "Elasticity",
    content:
`Elasticity measures responsiveness. Price elasticity of demand = % change in quantity demanded / % change in price.
If |PED| > 1 demand is elastic; < 1 inelastic. Income elasticity, cross elasticity also important for businesses.`,
    keywords: ["elasticity","price elasticity","ped","income elasticity","cross elasticity"],
    course: "Elementary Microeconomics"
  },
  {
    id: "costs",
    title: "Costs (Fixed, Variable, Marginal)",
    content:
`Fixed costs do not change with output (rent, salaries). Variable costs change (materials).
Total cost = fixed + variable. Marginal cost = cost to produce one more unit. Firms use these for pricing and production decisions.`,
    keywords: ["fixed cost","variable cost","marginal cost","total cost","production"],
    course: "Elementary Microeconomics"
  },
  {
    id: "market_structures",
    title: "Market Structures",
    content:
`Perfect competition: many firms, identical products, price takers.
Monopoly: single seller, high barriers to entry.
Oligopoly: few large firms, strategic behaviour.
Monopolistic competition: many firms, differentiated products.`,
    keywords: ["perfect competition","monopoly","oligopoly","monopolistic","market structure"],
    course: "Elementary Microeconomics"
  },
  {
    id: "macro_intro",
    title: "Macroeconomics ‚Äî Introduction",
    content:
`Macroeconomics studies the whole economy: GDP, inflation, unemployment, fiscal and monetary policy, economic growth and balance of payments.`,
    keywords: ["macroeconomics","gdp","inflation","unemployment","fiscal policy","monetary policy"],
    course: "Elementary Microeconomics"
  },
  {
    id: "gdp_inflation",
    title: "GDP & Inflation",
    content:
`GDP = market value of final goods and services. Inflation = sustained increase in price level (CPI often used).
High inflation reduces purchasing power; deflation can harm growth.`,
    keywords: ["gdp","inflation","cpi","price level"],
    course: "Elementary Microeconomics"
  },
  {
    id: "elementary_microeconomics",
    title: "Elementary Microeconomics - Full Course",
    content:
`Elementary Microeconomics studies individual economic units like households, firms, and markets. It examines how these entities make decisions and interact in specific markets.

Key Topics:
‚Ä¢ Scarcity, choice, and opportunity cost
‚Ä¢ Demand and supply analysis
‚Ä¢ Market equilibrium and price determination
‚Ä¢ Elasticity concepts (price, income, cross)
‚Ä¢ Consumer behavior theory
‚Ä¢ Production and costs
‚Ä¢ Market structures (perfect competition, monopoly, oligopoly, monopolistic competition)
‚Ä¢ Factor markets (labor, capital, land)

Core Principles:
1. People face trade-offs
2. The cost of something is what you give up to get it
3. Rational people think at the margin
4. People respond to incentives`,
    keywords: ["microeconomics", "demand", "supply", "elasticity", "market structures", "opportunity cost", "scarcity", "equilibrium", "consumer behavior", "production", "costs"],
    course: "Elementary Microeconomics"
  },
  {
    id: "fundamentals_accounting",
    title: "Fundamentals of Accounting",
    content:
`Fundamentals of Accounting covers the complete accounting cycle and financial reporting process.

Course Units:
1. Introduction to Financial Accounting - Basic concepts, users of accounting information
2. Accounting Equation & Balance Sheet - Assets = Liabilities + Owner's Equity
3. Double Entry Bookkeeping - Debits and credits, balancing accounts
4. Trial Balance & Financial Statements - Income statement, balance sheet preparation
5. Adjustments for Financial Statements - Accruals, prepayments, depreciation
6. Inventory Valuation - FIFO, LIFO, weighted average methods
7. Accounting Concepts - Going concern, accruals, consistency, prudence
8. Books of Original Entry & Ledger - Journals, cash book, general ledger
9. Bank Reconciliations - Matching bank statements with cash records
10. Partnership Financial Statements - Profit sharing, capital accounts
11. Limited Company Financial Statements - Share capital, reserves, dividends

Key Skills: Recording transactions, preparing financial statements, interpreting financial data`,
    keywords: ["accounting", "double entry", "trial balance", "financial statements", "balance sheet", "ledger", "bank reconciliation", "partnership", "limited company", "debits", "credits", "assets", "liabilities"],
    course: "Fundamentals of Accounting"
  },
  {
    id: "computer_systems",
    title: "Introduction to Computer Systems",
    content:
`Introduction to Computer Systems covers fundamental concepts of computing technology and systems.

Main Components:
‚Ä¢ Hardware: CPU, memory, storage devices, input/output devices
‚Ä¢ Software: Operating systems, application software, utilities
‚Ä¢ Data: Representation, storage, processing
‚Ä¢ Networking: Basic concepts, internet protocols

Key Topics:
- Computer architecture and organization
- Operating system functions (Windows, Linux, macOS)
- Data representation (binary, hexadecimal)
- Memory hierarchy (cache, RAM, secondary storage)
- Input/output systems
- Basic networking concepts
- Computer security fundamentals
- Emerging technologies

Practical Skills: File management, basic troubleshooting, software installation, hardware identification`,
    keywords: ["computer systems", "hardware", "software", "operating systems", "networking", "data representation", "computer architecture", "cpu", "memory", "storage", "input devices", "output devices"],
    course: "Introduction to Computer Systems"
  },
  {
    id: "organizational_psychology",
    title: "Organizational Psychology",
    content:
`Organizational Psychology applies psychological principles to workplace behavior and organizational effectiveness.

Course Modules:
1. Nature & Scope of I-O Psychology - Definition, history, multicultural issues
2. Individual Differences - Personality, intelligence, assessment methods
3. Job Analysis - Performance models, job evaluation techniques
4. Training & Development - Learning principles, training methods, evaluation
5. Work Motivation - Classic and modern motivational theories
6. Work Attitudes & Emotions - Job satisfaction, organizational commitment
7. Stress & Well-being - Stress theories, management techniques, workplace violence
8. Team Effectiveness - Team types, input-process-output model
9. Organizational Behavior - Social dynamics, group behavior
10. Organizational Development - Change management, intervention strategies

Applications: Employee selection, performance management, leadership development, organizational change`,
    keywords: ["organizational psychology", "motivation", "job analysis", "training", "stress management", "team effectiveness", "organizational development", "workplace behavior", "leadership", "employee selection"],
    course: "Organizational Psychology"
  },
  {
    id: "life_managerial_skills",
    title: "Life and Managerial Skills",
    content:
`Life and Managerial Skills develops essential competencies for personal and professional effectiveness.

Core Areas:
a) Personal Skills Development
   - Self-awareness, emotional intelligence, learning styles
   - Values clarification, attitude toward change

b) Stress Management
   - Stress identification and coping strategies
   - Managing fear, depression, anger in institutional settings
   - Crisis and disaster management

c) Social & Conflict Management
   - Effective interpersonal interactions
   - Conflict types and resolution techniques
   - Body language interpretation and assertiveness

d) Interpersonal & Leadership Skills
   - Team building and team spirit
   - Leadership styles and emotional intelligence
   - Negotiation skills and preparation

e) Time Management
   - Identifying time wasters (procrastination)
   - Time management strategies and benefits

f) Empowerment & Ethics
   - Innovation stimulation and change management
   - Power dynamics and managerial empowerment
   - Ethical conduct and social responsibility

g) Communication Arts
   - Oral presentations and meeting management
   - Reporting, case analysis, and academic writing skills`,
    keywords: ["managerial skills", "stress management", "conflict resolution", "time management", "leadership", "team building", "communication", "empowerment", "emotional intelligence", "negotiation", "ethics"],
    course: "Life and Managerial Skills"
  },
  {
    id: "english_academic_purposes",
    title: "English for Academic Purposes",
    content:
`English for Academic Purposes develops essential language and study skills for academic success.

Key Components:

1. Study Skills
   - Time management and work planning
   - Note-taking systems (Cornell method)
   - SMART goals setting
   - Overcoming procrastination
   - Study groups and learning styles

2. Listening Skills
   - Informative and reflective listening
   - Active listening techniques
   - Barriers to effective listening

3. Reading Skills
   - Skimming, scanning, inference strategies
   - SQ3R reading method
   - Text analysis: graphics, word relationships, semantic organizers
   - Scientific text comprehension

4. Writing Skills
   - Paragraph structure and development
   - Sentence types and common problems
   - Academic referencing (APA style)
   - Plagiarism avoidance

5. Examination Skills
   - Question type strategies (essay, multiple choice)
   - Examination preparation techniques
   - Time management during exams
   - Understanding instruction words

6. Library Skills
   - Information source identification
   - Classification systems
   - Electronic database access
   - Reference material usage`,
    keywords: ["academic english", "study skills", "listening skills", "reading skills", "writing skills", "examination techniques", "library skills", "referencing", "apa", "plagiarism", "note-taking"],
    course: "English for Academic Purposes"
  },
  {
    id: "business_law",
    title: "Business Law ‚Äî Contracts & Types",
    content:
`Contract essentials: offer, acceptance, consideration, capacity, and legality.
Contracts may be valid, void, or voidable. Company types: sole trader, partnership, private company, public company.`,
    keywords: ["contract","offer","acceptance","consideration","company","partnership","sole trader"],
    course: "Business Law"
  },
  {
    id: "management",
    title: "Business Management",
    content:
`Management functions: planning, organizing, staffing, directing, and controlling.
Levels: top, middle, lower. Forms of business ownership: sole trader, partnership, corporation, cooperative.`,
    keywords: ["management","planning","organizing","staffing","directing","controlling","business ownership"],
    course: "Business Management"
  },
  {
    id: "communication",
    title: "Communication Skills",
    content:
`Types: verbal, non-verbal, written, visual. Barriers: noise, language, culture, emotions. Key skills: clarity, active listening, feedback, confidence.`,
    keywords: ["communication","verbal","written","listening","feedback","barriers"],
    course: "Communication Skills"
  },
  {
    id: "ict",
    title: "ICT / Computer Applications",
    content:
`Basics of hardware and software, operating systems, MS Word/Excel/PowerPoint, internet basics, email, and file management. Data protection basics are essential.`,
    keywords: ["ict","computer","excel","word","powerpoint","internet","email","data protection"],
    course: "ICT Applications"
  },
  {
    id: "maths_business",
    title: "Mathematics for Business",
    content:
`Key topics: percentages, ratios, proportions, simple & compound interest, linear equations, demand/supply functions, and break-even analysis.`,
    keywords: ["percentages","ratios","interest","break-even","equations","maths"],
    course: "Business Mathematics"
  },
  {
    id: "life_skills",
    title: "Life & Managerial Skills",
    content:
`Life skills: cognitive, interpersonal and emotional skills. Important: time management, decision making, stress control, conflict resolution, and leadership.`,
    keywords: ["life skills","time management","decision making","stress","conflict resolution"],
    course: "Life Skills"
  },
  {
    id: "exam_tips",
    title: "Exam Tips & Study Strategy",
    content:
`Understand core concepts first. Make short notes, practice past papers, use diagrams and examples (use Malawi examples where possible). Manage time during exams and revise regularly.`,
    keywords: ["exam","revision","past papers","study","tips","exam tips"],
    course: "Study Strategies"
  }
];

/* -----------------------
   Enhanced AI Functions
   ----------------------- */

// Advanced tokenization with stemming
function tokenize(text) {
  return text.toLowerCase()
    .replace(/[^a-z0-9\s]/g, ' ')
    .split(/\s+/)
    .filter(Boolean)
    .map(word => {
      // Simple stemming
      if (word.length > 3) {
        if (word.endsWith('ing')) return word.slice(0, -3);
        if (word.endsWith('ed')) return word.slice(0, -2);
        if (word.endsWith('s')) return word.slice(0, -1);
      }
      return word;
    });
}

// Enhanced retrieval with multiple matching strategies
function retrieveBestMatch(question) {
  const qTokens = tokenize(question);
  let bestMatches = [];
  
  for (const item of KB) {
    let score = 0;
    const kws = item.keywords.map(k => k.toLowerCase());
    const titleTokens = tokenize(item.title);
    const contentTokens = tokenize(item.content);
    
    // Keyword matching (highest weight)
    for (const t of qTokens) {
      if (kws.some(k => k.includes(t) || t.includes(k))) score += 4;
    }
    
    // Title matching (medium weight)
    for (const t of qTokens) {
      if (titleTokens.includes(t)) score += 3;
    }
    
    // Content matching (lower weight)
    for (const t of qTokens) {
      if (contentTokens.includes(t)) score += 1;
    }
    
    // Course name matching
    if (item.course && question.toLowerCase().includes(item.course.toLowerCase())) {
      score += 5;
    }
    
    if (score > 0) {
      bestMatches.push({ score, item, matches: score });
    }
  }
  
  // Sort by score and return top 3 matches
  bestMatches.sort((a, b) => b.score - a.score);
  return bestMatches.slice(0, 3);
}

// Confidence calculation
function calculateConfidence(matches) {
  if (matches.length === 0) return 0;
  const maxScore = Math.max(...matches.map(m => m.score));
  return Math.min(100, (maxScore / 20) * 100); // Normalize to 100
}

// Generate follow-up questions
function generateFollowUpQuestions(mainTopic, question) {
  const followUps = [];
  const q = question.toLowerCase();
  
  if (q.includes('what is') || q.includes('define')) {
    followUps.push(`Explain ${mainTopic.title} with examples`);
    followUps.push(`What are the key concepts in ${mainTopic.title}?`);
    followUps.push(`How is ${mainTopic.title} applied in business?`);
  } else if (q.includes('how') || q.includes('work')) {
    followUps.push(`What are the steps in ${mainTopic.title}?`);
    followUps.push(`What are the benefits of ${mainTopic.title}?`);
    followUps.push(`Can you give a Malawi example of ${mainTopic.title}?`);
  } else if (q.includes('why') || q.includes('important')) {
    followUps.push(`What are the advantages of ${mainTopic.title}?`);
    followUps.push(`How does ${mainTopic.title} affect business decisions?`);
    followUps.push(`What problems does ${mainTopic.title} solve?`);
  } else {
    // Default follow-ups
    followUps.push(`Explain this in simpler terms`);
    followUps.push(`Give me a practical example`);
    followUps.push(`How is this relevant to Malawi businesses?`);
  }
  
  return followUps;
}

// Enhanced reply composition
function composeReply(question) {
  const matches = retrieveBestMatch(question);
  const confidence = calculateConfidence(matches);
  
  if (matches.length > 0 && confidence >= 40) {
    const mainMatch = matches[0];
    let reply = `üìö ${mainMatch.item.title}\n\n${mainMatch.item.content}`;
    
    // Add course context
    if (mainMatch.item.course) {
      reply += `\n\nüìñ Course: ${mainMatch.item.course}`;
    }
    
    // Add confidence indicator
    reply += `\n\n<div class="confidence-meter">Confidence: ${Math.round(confidence)}% ‚Ä¢ Source: Course Notes</div>`;
    
    // Add example
    const example = generateExample(mainMatch.item.id, question);
    reply += `\n\n${example}`;
    
    // Add follow-up questions if confidence is high
    if (confidence >= 70) {
      const followUps = generateFollowUpQuestions(mainMatch.item, question);
      reply += `\n\n<div class="follow-up-questions">`;
      reply += `<div class="follow-up-title">Related questions you might ask:</div>`;
      followUps.forEach(fq => {
        reply += `<div class="follow-up-item" onclick="document.getElementById('userInput').value='${fq}'; handleSend();">‚Ä¢ ${fq}</div>`;
      });
      reply += `</div>`;
    }
    
    return reply;
  } else {
    // Smart fallback with multiple strategies
    return smartFallback(question, matches, confidence);
  }
}

// Smart fallback when no good matches
function smartFallback(question, matches, confidence) {
  const q = question.toLowerCase();
  
  // Try to identify course context
  const courses = [...new Set(KB.map(item => item.course))];
  const courseMatch = courses.find(course => 
    course && q.includes(course.toLowerCase())
  );
  
  if (courseMatch) {
    return `I don't have specific notes on "${question}" in ${courseMatch}, but here's general advice:\n\n‚Ä¢ Review the core concepts of ${courseMatch}\n‚Ä¢ Look for related topics in your course materials\n‚Ä¢ Practice with examples from Malawian businesses\n‚Ä¢ Ask your instructor for clarification on this specific topic\n\nConfidence: ${Math.round(confidence)}%`;
  }
  
  // General study advice based on question type
  if (q.includes('exam') || q.includes('test') || q.includes('study')) {
    return `üìù Exam Preparation Tips:\n\n1. Create a study schedule and stick to it\n2. Focus on understanding concepts rather than memorization\n3. Practice with past papers and time yourself\n4. Use mind maps and diagrams for visual learning\n5. Form study groups for discussion\n6. Get adequate rest before exams\n7. Read questions carefully during exams\n\nüá≤üáº Malawi Context: Relate concepts to local businesses like Illovo, Press Corporation, or small enterprises in your community.`;
  }
  
  if (q.includes('assignment') || q.includes('project')) {
    return `üìã Assignment Guidance:\n\n1. Start early and plan your time\n2. Understand the assignment requirements clearly\n3. Research using multiple sources\n4. Structure your work with clear introduction, body, and conclusion\n5. Use proper referencing (APA style)\n6. Proofread for errors\n7. Submit before deadline\n\nüí° Tip: Use real Malawian business examples to make your assignment more relevant.`;
  }
  
  // Default intelligent response
  return `ü§î I'm not entirely sure about "${question}". Here's how I can help:\n\n‚Ä¢ Use the üìö button to browse specific course topics\n‚Ä¢ Ask about specific concepts like "demand and supply" or "accounting equation"\n‚Ä¢ Request exam tips or study strategies\n‚Ä¢ Ask for Malawi-specific business examples\n\nConfidence: ${Math.round(confidence)}% ‚Ä¢ Try rephrasing your question for better results.`;
}

// Enhanced example generation
function generateExample(kbId, question) {
  const examples = {
    "demand_supply": "üá≤üáº Example: When maize prices rise in Malawi due to poor harvests, quantity demanded decreases as consumers switch to alternatives like cassava, while suppliers may increase production if they expect higher profits.",
    "micro_intro": "üá≤üáº Example: A small shop in Blantyre deciding between stocking imported rice or local maize faces opportunity costs‚Äîthe profit lost from not choosing the alternative.",
    "elasticity": "üá≤üáº Example: Salt has inelastic demand in Malawi (people buy similar amounts despite price changes), while airtime for mobile phones is more elastic.",
    "fundamentals_accounting": "üá≤üáº Example: A Malawian small business owner uses double-entry bookkeeping to track sales (credit revenue) and expenses (debit costs) for accurate financial reporting.",
    "computer_systems": "üá≤üáº Example: Malawian businesses use computer systems for inventory management, payroll processing, and connecting with customers through email and social media.",
    "organizational_psychology": "üá≤üáº Example: A manager at a Lilongwe company uses motivational theories to improve employee performance through recognition and career development opportunities.",
    "life_managerial_skills": "üá≤üáº Example: Effective time management helps Malawian professionals balance work responsibilities with family commitments and community activities.",
    "english_academic_purposes": "üá≤üáº Example: Using the Cornell note-taking system helps Malawian students better organize lecture notes for exam preparation.",
    "default": "üí° Tip: Apply this concept to a Malawian context‚Äîconsider how local businesses, farmers, or government policies might be affected."
  };
  
  return examples[kbId] || examples.default;
}

// Generate suggestion chips
function generateSuggestionChips() {
  const suggestions = [
    "Explain demand and supply",
    "What is double entry accounting?",
    "How to manage stress?",
    "Give me exam tips",
    "Explain market structures",
    "What is organizational psychology?",
    "How to write a good paragraph?",
    "Time management strategies"
  ];
  
  const container = document.getElementById('suggestionChips');
  container.innerHTML = '';
  
  suggestions.forEach(suggestion => {
    const chip = document.createElement('div');
    chip.className = 'suggestion-chip';
    chip.textContent = suggestion;
    chip.addEventListener('click', () => {
      document.getElementById('userInput').value = suggestion;
      handleSend();
    });
    container.appendChild(chip);
  });
}

/* -----------------------
   UI Functionality
   ----------------------- */
const themeToggle = document.getElementById('theme-toggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Load saved theme
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  themeToggle.textContent = '‚òÄÔ∏è';
}

/* -----------------------
   Knowledge base panel toggle
   ----------------------- */
const kbToggle = document.getElementById('kb-toggle');
const kbPanel = document.getElementById('kb-panel');
const closeKb = document.getElementById('close-kb');

kbToggle.addEventListener('click', () => {
  kbPanel.classList.add('open');
});

closeKb.addEventListener('click', () => {
  kbPanel.classList.remove('open');
});

// Close panel when clicking outside
document.addEventListener('click', (e) => {
  if (!kbPanel.contains(e.target) && !kbToggle.contains(e.target) && kbPanel.classList.contains('open')) {
    kbPanel.classList.remove('open');
  }
});

/* -----------------------
   Chat UI + logic
   ----------------------- */
const chatbox = document.getElementById('chatbox');
const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clear-btn');
const kbList = document.getElementById('kbList');

let history = JSON.parse(localStorage.getItem('luanar_chat_history')) || [];

/* Format time for messages */
function formatTime(date = new Date()) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

/* render KB list */
function renderKB(){
  kbList.innerHTML = '';
  for(const item of KB){
    const node = document.createElement('div');
    node.className = 'kb-item';
    node.innerHTML = `<h4>${item.title}</h4><p>${item.content.substring(0,100)}${item.content.length>100?"...":""}</p><small style="color:var(--accent);">${item.course}</small>`;
    node.addEventListener('click', ()=> {
      input.value = `Explain ${item.title}`;
      input.focus();
      kbPanel.classList.remove('open');
    });
    kbList.appendChild(node);
  }
}

/* render history */
function renderHistory(){
  chatbox.innerHTML = '';
  for(const m of history){
    appendMessage(m.text, m.sender, m.time, false);
  }
  chatbox.scrollTop = chatbox.scrollHeight;
}

function appendMessage(text, sender, time = Date.now(), save = true){
  // Remove any existing typing indicator
  const typingIndicator = document.querySelector('.typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
  
  const div = document.createElement('div');
  div.className = 'message ' + (sender==='user' ? 'user' : 'bot');
  
  const timeFormatted = formatTime(new Date(time));
  div.innerHTML = `${text}<div class="message-time">${timeFormatted}</div>`;
  
  chatbox.appendChild(div);
  chatbox.scrollTop = chatbox.scrollHeight;
  
  if(save){
    history.push({text, sender, time});
    localStorage.setItem('luanar_chat_history', JSON.stringify(history));
  }
}

function showTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator';
  typingDiv.innerHTML = `
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  `;
  chatbox.appendChild(typingDiv);
  chatbox.scrollTop = chatbox.scrollHeight;
}

/* send flow */
async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  appendMessage(q, 'user');
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  // Compute answer (simulate small delay)
  setTimeout(() => {
    const reply = composeReply(q);
    appendMessage(reply, 'bot');
    
    // Regenerate suggestion chips after response
    setTimeout(generateSuggestionChips, 100);
  }, 800 + Math.random() * 800);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', e => { 
  if(e.key === 'Enter') handleSend(); 
});

clearBtn.addEventListener('click', ()=> {
  if(confirm('Clear chat history? This will remove saved messages from this browser.')){
    history = [];
    localStorage.removeItem('luanar_chat_history');
    renderHistory();
    appendMessage("Welcome! I'm the üêù Agogo Smart AI Tutor. I now have enhanced understanding of all your courses. Ask about any topic or use the üìö icon to browse course notes.", 'bot');
    generateSuggestionChips();
  }
});

/* keyboard shortcuts */
input.addEventListener('input', e=>{
  const value = e.target.value.trim().toLowerCase();
  if(value === 'topics'){
    e.target.value = '';
    const titles = KB.map(i=>`‚Ä¢ ${i.title} (${i.course})`).join('\n');
    appendMessage('Available topics:\n' + titles, 'bot');
  } else if (value === 'courses') {
    e.target.value = '';
    const courses = [...new Set(KB.map(item => item.course))].filter(Boolean);
    appendMessage('Available courses:\n' + courses.map(c => `‚Ä¢ ${c}`).join('\n'), 'bot');
  }
});

/* initial render */
renderKB();
renderHistory();
generateSuggestionChips();

/* If no history, show a welcome message */
if(history.length === 0){
  appendMessage("Welcome! I'm the üêù Agogo Smart AI Tutor. I now have enhanced understanding of all your courses including:\n\n‚Ä¢ Elementary Microeconomics\n‚Ä¢ Fundamentals of Accounting\n‚Ä¢ Computer Systems\n‚Ä¢ Organizational Psychology\n‚Ä¢ Life & Managerial Skills\n‚Ä¢ English for Academic Purposes\n\nAsk me anything about these courses, or use the üìö icon to browse specific topics!", 'bot');
}

/* Expose enhanced functions for debugging */
window.SMART_AI = {
  KB,
  retrieveBestMatch,
  composeReply,
  calculateConfidence
};
</script>
</body>
</html>